# 既存コードベース分析レポート

## 概要

本文書は、DeepWiki-Open-MultiRepo（DeepWiki-OMR）の実装に向けて、既存のfork済みdeepwiki-openコードベースの分析結果をまとめたものです。

## 既存アーキテクチャの理解

### バックエンド構成（FastAPI）

#### 主要ファイル構成
- `api/main.py`: アプリケーションエントリーポイント
- `api/api.py`: FastAPIアプリケーション本体とAPIエンドポイント
- `api/rag.py`: RAG（Retrieval-Augmented Generation）機能
- `api/data_pipeline.py`: データ処理パイプライン
- `api/config.py`: 設定管理
- `api/simple_chat.py`: チャット機能
- `api/websocket_wiki.py`: WebSocket通信

#### 既存の主要機能

##### 1. Wiki生成・管理機能
- **WikiCacheData**: Wiki構造とページデータの管理
- **ProcessedProjectEntry**: 処理済みプロジェクトの管理
- **キャッシュシステム**: ローカルファイルシステムベースのキャッシュ

##### 2. RAG検索機能
- **RAG クラス**: 単一リポジトリ対応のRAG実装
- **FAISSRetriever**: ベクトル検索機能
- **Memory**: 会話履歴管理
- **埋め込み生成**: 複数プロバイダー対応（Google、OpenAI、Ollama等）

##### 3. データ処理パイプライン
- **リポジトリクローン**: GitHub、GitLab、Bitbucket対応
- **ドキュメント読み込み**: コードファイルと文書ファイルの処理
- **テキスト分割**: チャンク化処理
- **埋め込み生成**: ベクトル化処理

##### 4. API エンドポイント
```python
# 既存の主要エンドポイント
GET  /api/wiki_cache          # Wikiキャッシュ取得
POST /api/wiki_cache          # Wikiキャッシュ保存
DELETE /api/wiki_cache        # Wikiキャッシュ削除
GET  /api/processed_projects  # 処理済みプロジェクト一覧
POST /chat/completions/stream # ストリーミングチャット
GET  /models/config          # モデル設定取得
```

### フロントエンド構成（Next.js + React）

#### 主要コンポーネント構成
- `src/app/page.tsx`: メインページ
- `src/components/WikiTreeView.tsx`: Wiki目次表示
- `src/components/Ask.tsx`: チャット・質問機能
- `src/components/ProcessedProjects.tsx`: プロジェクト一覧表示
- `src/components/ConfigurationModal.tsx`: 設定モーダル

#### 既存の主要機能

##### 1. Wiki表示機能
- **WikiTreeView**: 階層構造を持つWiki目次表示
- **WikiPage**: ページコンテンツ表示
- **WikiSection**: セクション管理

##### 2. 検索・チャット機能
- **Ask コンポーネント**: RAG検索とチャット機能
- **Deep Research**: 多段階研究機能
- **WebSocket通信**: リアルタイム応答

##### 3. プロジェクト管理機能
- **ProcessedProjects**: 処理済みプロジェクト一覧
- **ConfigurationModal**: リポジトリ設定
- **ModelSelectionModal**: モデル選択

## マルチリポジトリ対応のための拡張ポイント

### 1. データモデルの拡張が必要な箇所

#### 現在の制限
```typescript
// 現在は単一リポジトリ前提
interface WikiCacheData {
  wiki_structure: WikiStructureModel;
  generated_pages: Dict[str, WikiPage];
  repo_url?: str;  // 単一URL
  repo: RepoInfo;  // 単一リポジトリ情報
}
```

#### 拡張方針
```typescript
// マルチリポジトリ対応
interface MultiRepoWikiCacheData {
  repositories: Map<string, RepoInfo>;  // リポジトリID -> 情報
  wiki_structures: Map<string, WikiStructureModel>;  // リポジトリID -> Wiki構造
  generated_pages: Map<string, Map<string, WikiPage>>;  // リポジトリID -> ページID -> ページ
  cross_repo_links: CrossRepoLink[];  // リポジトリ間リンク
}
```

### 2. APIエンドポイントの拡張が必要な箇所

#### 現在のエンドポイント
```python
# 単一リポジトリ前提
GET /api/wiki_cache?owner=xxx&repo=xxx&repo_type=xxx&language=xxx
```

#### 拡張後のエンドポイント
```python
# マルチリポジトリ対応
GET /api/repos                           # リポジトリ一覧
POST /api/repos                          # リポジトリ登録
GET /api/repos/{repo_id}                 # リポジトリ詳細
DELETE /api/repos/{repo_id}              # リポジトリ削除
POST /api/repos/{repo_id}/parse          # 解析開始
GET /api/repos/{repo_id}/wiki            # Wiki取得
GET /api/search                          # 横断検索
POST /api/search/rag                     # RAG検索
```

### 3. RAG機能の拡張が必要な箇所

#### 現在の制限
```python
class RAG(adal.Component):
    def prepare_retriever(self, repo_url_or_path: str, ...):
        # 単一リポジトリのみ対応
        self.transformed_docs = self.db_manager.prepare_database(repo_url_or_path, ...)
```

#### 拡張方針
```python
class MultiRepoRAG(RAG):
    def prepare_multi_repo_retriever(self, repo_ids: List[str]):
        # 複数リポジトリ対応
        all_docs = []
        for repo_id in repo_ids:
            docs = self.db_manager.get_repo_documents(repo_id)
            all_docs.extend(docs)
        self.transformed_docs = all_docs
```

### 4. フロントエンドコンポーネントの拡張が必要な箇所

#### WikiTreeView の拡張
```typescript
// 現在: 単一リポジトリのWiki構造
interface WikiTreeViewProps {
  wikiStructure: WikiStructure;
  currentPageId: string | undefined;
  onPageSelect: (pageId: string) => void;
}

// 拡張後: マルチリポジトリ対応
interface MultiRepoWikiTreeViewProps {
  repositories: Repository[];
  currentRepoId: string;
  wikiStructures: Map<string, WikiStructure>;
  currentPageId: string | undefined;
  onRepoSelect: (repoId: string) => void;
  onPageSelect: (repoId: string, pageId: string) => void;
}
```

#### Ask コンポーネントの拡張
```typescript
// 現在: 単一リポジトリ対象
interface AskProps {
  repoInfo: RepoInfo;
  // ...
}

// 拡張後: マルチリポジトリ対応
interface MultiRepoAskProps {
  repositories: RepoInfo[];
  selectedRepoIds: string[];  // 検索対象リポジトリ
  onRepoFilterChange: (repoIds: string[]) => void;
  // ...
}
```

## 活用可能な既存機能

### 1. そのまま活用できる機能
- **基本的なUI基盤**: Next.js + React の構成
- **認証システム**: トークンベース認証
- **テーマシステム**: ダーク/ライトモード
- **国際化対応**: 多言語サポート基盤
- **基本的なWiki表示**: Markdownレンダリング
- **基本的な検索UI**: 検索ボックス、結果表示

### 2. 拡張が必要だが基盤として活用できる機能
- **RAG機能**: 単一→マルチリポジトリ対応に拡張
- **データパイプライン**: リポジトリ管理機能を追加
- **Wiki生成**: マルチリポジトリ対応に拡張
- **キャッシュシステム**: DynamoDB統合に移行
- **API基盤**: エンドポイント追加・拡張

### 3. 新規実装が必要な機能
- **リポジトリ管理システム**: CRUD操作
- **横断検索機能**: 複数リポジトリ対象
- **Webhook統合**: 自動更新機能
- **AWS統合**: DynamoDB、OpenSearch、S3
- **非同期ジョブ処理**: SQS統合

## 技術スタック分析

### 現在使用中の技術
- **バックエンド**: FastAPI, Python 3.11+
- **フロントエンド**: Next.js 15, React 19, TypeScript
- **AI/ML**: AdalFlow, Google Generative AI, OpenAI
- **データ処理**: FAISS, tiktoken
- **UI**: Tailwind CSS, React Icons
- **通信**: WebSocket, HTTP streaming

### 追加が必要な技術
- **AWS SDK**: boto3 (DynamoDB, OpenSearch, S3, SQS)
- **インフラ**: AWS CDK または Terraform
- **コンテナ**: Docker, ECS Fargate
- **監視**: CloudWatch, X-Ray
- **セキュリティ**: AWS Secrets Manager, KMS

## 移行戦略

### Phase 1: 基盤拡張
1. 既存APIにマルチリポジトリ対応エンドポイント追加
2. データモデルの拡張
3. 基本的なリポジトリ管理機能実装

### Phase 2: AWS統合
1. DynamoDB統合
2. S3統合
3. 基本的なAWS認証・権限設定

### Phase 3: 高度な機能
1. OpenSearch統合
2. SQS統合
3. Webhook機能

### Phase 4: 最適化
1. パフォーマンス最適化
2. 監視・ログ強化
3. セキュリティ強化

## 結論

既存のdeepwiki-openコードベースは、マルチリポジトリ対応への拡張に適した構造を持っています。特に以下の点で優れた基盤となります：

1. **モジュラー設計**: 各機能が適切に分離されており、拡張しやすい
2. **型安全性**: TypeScriptによる型定義が充実
3. **拡張性**: プラグイン的な構造でプロバイダー追加が容易
4. **UI基盤**: 完成度の高いReactコンポーネント群

主な拡張作業は、既存機能の「単一リポジトリ」前提を「マルチリポジトリ」対応に変更することと、AWS統合による永続化・スケーラビリティの実現です。

既存コードの約70%は再利用可能であり、効率的な開発が期待できます。