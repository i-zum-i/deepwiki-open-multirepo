# 要件定義書

## はじめに

本文書は、複数のGitリポジトリからAIを使用して自動的にドキュメントを生成するマルチリポジトリWikiシステム「DeepWiki-Open-MultiRepo」（略称：DeepWiki-OMR）の要件を定義します。本システムは既存のdeepwiki-openフォークの拡張として構築され、AWSネイティブアーキテクチャとBedrock Claude統合、リポジトリ横断検索機能、自動更新メカニズムを提供します。

本システムは、コードリポジトリからの自動Wiki生成のためのスケーラブルで安全かつ保守可能なインフラストラクチャを提供することを目的とし、GitHubとAWS CodeCommitソースの両方をサポートし、全文検索とRAGベースのセマンティック検索を含む包括的な検索機能を提供します。

## 要件

### 要件1：リポジトリ管理

**ユーザーストーリー:** 開発チームメンバーとして、異なるプロバイダーの複数のGitリポジトリを登録したい。そうすることで、すべてのコードベースのドキュメントを一元管理・アクセスできるようになる。

#### 受け入れ基準

1. ユーザーがリポジトリ情報（provider, remote_url, display_name, branch）を提供した場合、システムはリポジトリを検証してデータベースに登録しなければならない
2. GitHubリポジトリを登録する場合、システムは`https://github.com/<org>/<repo>.git`形式のURLを受け入れなければならない
3. CodeCommitリポジトリを登録する場合、システムは`codecommit://<repo>`、`codecommit::<region>://<repo>`、または`https://git-codecommit.<region>.amazonaws.com/v1/repos/<name>`形式のURLを受け入れなければならない
4. リポジトリが登録された場合、システムはprovider、remote_url、display_name、default_branch、status、last_scan_sha、last_scan_atを含むメタデータを保存しなければならない
5. リポジトリを一覧表示する場合、システムは現在のステータス（READY|PARSING|FAILED）と最終更新情報を含むすべての登録済みリポジトリを表示しなければならない
6. リポジトリを削除する場合、システムは履歴データを保持しながら論理削除を実行しなければならない

### 要件2：自動解析とWiki生成

**ユーザーストーリー:** 開発者として、システムにコードリポジトリを自動解析させ、包括的なWikiドキュメントを生成してもらいたい。そうすることで、手動メンテナンスなしに最新のドキュメントにアクセスできるようになる。

#### 受け入れ基準

1. リポジトリ解析を開始する場合、システムはFULLとINCREMENTALの両方の解析モードをサポートしなければならない
2. FULL解析を実行する場合、システムはリポジトリ全体をクローンしてすべてのファイルを処理しなければならない
3. INCREMENTAL解析を実行する場合、システムは`git diff --name-status <last_sha>..HEAD`を使用して変更されたファイルを特定し、追加、更新、削除のみを処理しなければならない
4. コードを解析する場合、システムはAST解析と章立て構造化を実行しなければならない
5. 埋め込みを生成する場合、システムはベクトル表現にBedrock Titan-Embed v2を使用しなければならない
6. ドキュメントを生成する場合、システムはWikiコンテンツ生成にBedrock Claudeを使用しなければならない
7. 解析が完了した場合、システムは生成されたWikiコンテンツをS3に保存し、DynamoDBのメタデータを更新しなければならない
8. 解析が失敗した場合、システムはエラーをログに記録し、リポジトリステータスをFAILEDに更新し、再試行機能を提供しなければならない

### 要件3：横断検索機能

**ユーザーストーリー:** ユーザーとして、全文検索とセマンティック検索の両方を使用して複数のリポジトリを横断検索したい。そうすることで、どのリポジトリに含まれているかに関係なく、関連情報を迅速に見つけることができるようになる。

#### 受け入れ基準

1. 全文検索を実行する場合、システムはOpenSearch BM25アルゴリズムを使用し、応答時間p95 < 1.0sを実現しなければならない
2. 全文検索を実行する場合、システムは特定のリポジトリでのフィルタリングまたはすべてのリポジトリでの検索をサポートしなければならない
3. RAG検索を実行する場合、システムはBedrockを使用してクエリを埋め込み、OpenSearchでkNN検索を実行しなければならない
4. RAG検索を実行する場合、システムはtop-k検索結果からのコンテキストを使用してClaudeで回答を生成し、応答時間p95 < 4.0sを実現しなければならない
5. RAG検索結果を提供する場合、システムはファイルパスとソースへのリンクを含む少なくとも3つの引用を含めなければならない
6. 検索でリポジトリが指定されていない場合、システムはデフォルトですべての登録済みリポジトリを検索しなければならない
7. 検索結果が返される場合、システムは特定のWikiページに移動するためのクリック可能なリンクを提供しなければならない

### 要件4：自動更新機能

**ユーザーストーリー:** リポジトリメンテナーとして、コード変更がプッシュされたときにシステムにドキュメントを自動更新してもらいたい。そうすることで、手動介入なしにドキュメントが最新のコードと同期された状態を保つことができるようになる。

#### 受け入れ基準

1. GitHubリポジトリがプッシュを受信した場合、システムは適切な署名検証を伴うWebhook通知を受信しなければならない
2. CodeCommitリポジトリがプッシュを受信した場合、システムはAPI Gateway経由でEventBridge通知を受信しなければならない
3. Webhookを受信した場合、システムは処理前に署名/トークンを検証しなければならない
4. 有効なWebhookが処理された場合、システムは対象リポジトリを特定し、INCREMENTAL解析ジョブをキューに追加しなければならない
5. Webhook検証が失敗した場合、システムは失敗をログに記録し、リクエストを拒否しなければならない
6. 自動更新がトリガーされた場合、システムは変更されたファイルとその依存関係のみを更新しなければならない
7. 自動更新が完了した場合、システムはリポジトリステータスと最終スキャン情報を更新しなければならない

### 要件5：Wiki閲覧機能

**ユーザーストーリー:** ユーザーとして、直感的なナビゲーションで生成されたWikiドキュメントを閲覧したい。そうすることで、コードベース構造を簡単に探索し理解できるようになる。

#### 受け入れ基準

1. リポジトリのWikiにアクセスする場合、システムは階層構造を持つ目次を表示しなければならない
2. Wikiページをナビゲートする場合、システムはパンくずナビゲーションを提供しなければならない
3. Wikiコンテンツを表示する場合、システムは適切なフォーマットでS3からコンテンツをレンダリングしなければならない
4. 複数のリポジトリを閲覧する場合、システムはリポジトリセレクターインターフェースを提供しなければならない
5. Wikiコンテンツが更新された場合、システムは変更をUIに即座に反映しなければならない
6. Wikiページにアクセスする場合、システムはリポジトリ内の元のソースファイルへのリンクを提供しなければならない

### 要件6：監視とエラーハンドリング

**ユーザーストーリー:** システム管理者として、包括的な監視とエラーハンドリングを行いたい。そうすることで、システムの信頼性を確保し、問題を効果的にトラブルシューティングできるようになる。

#### 受け入れ基準

1. ジョブを処理する場合、システムは失敗したジョブ用のDLQを伴う非同期ジョブキューイングにSQSを使用しなければならない
2. ジョブが失敗した場合、システムは指数バックオフを伴う再試行ロジックを実装しなければならない
3. システムエラーが発生した場合、システムは機密データをマスキングしてCloudWatchに詳細なエラー情報をログに記録しなければならない
4. システムヘルスを監視する場合、システムはジョブ成功/失敗率、レイテンシメトリクス、DLQ蓄積を追跡しなければならない
5. Webhook検証が繰り返し失敗する場合、システムは潜在的なセキュリティ問題に対するアラートを生成しなければならない
6. OpenSearchが429/5xxエラーを返す場合、システムは適切な再試行とサーキットブレーカーパターンを実装しなければならない
7. システムパフォーマンスが低下した場合、システムは検索レイテンシとジョブ処理時間のメトリクスを提供しなければならない

### 要件7：セキュリティ管理

**ユーザーストーリー:** セキュリティを重視する組織として、堅牢なセキュリティ制御とアクセス管理を行いたい。そうすることで、機密コードとドキュメントが適切に保護されるようになる。

#### 受け入れ基準

1. 機密情報を保存する場合、システムはPAT、GitHub Appクレデンシャル、Webhook署名にKMS暗号化を伴うAWS Secrets Managerを使用しなければならない
2. AWSサービスにアクセスする場合、システムはBedrock、S3、DynamoDB、OpenSearch、SQSに対して最小限必要な権限を持つIAMロールを使用しなければならない
3. Webhookを処理する場合、システムは署名を検証し、レート制限を実装しなければならない
4. システム活動をログに記録する場合、システムはすべてのログ出力で機密値をマスキングしなければならない
5. 可能な場合、システムはWebhookエンドポイントのIP許可リストを実装しなければならない
6. Bedrockにアクセスする場合、システムは特定のClaudeと埋め込みモデルのみに権限を制限しなければならない
7. 認証を処理する場合、システムは管理機能のトークンベース認証をサポートしなければならない

### 要件8：スケーラビリティと多言語対応

**ユーザーストーリー:** 開発チームとして、システムに複数言語と大規模リポジトリを効率的に処理してもらいたい。そうすることで、多様で成長するコードベースに合わせてスケールできるようになる。

#### 受け入れ基準

1. 日本語と英語のコンテンツを処理する場合、システムはシンプルと日本語形態素解析の両方をサポートするマルチフィールドマッピングでOpenSearchを設定しなければならない
2. 大規模リポジトリを処理する場合、システムは解析のページネーションを実装し、並行ジョブ実行を制御しなければならない
3. システムをスケールする場合、システムはECS Fargateを使用した水平スケーリングをサポートしなければならない
4. 埋め込みを処理する場合、システムは選択された埋め込みモデル（Titan-Embed v2）の適切なベクトル次元を処理しなければならない
5. コストを管理する場合、システムはBedrock、OpenSearch、S3の使用コストの可視性を提供しなければならない
6. システム負荷が増加した場合、システムはSQSキューの深さに基づいてワーカーを自動的にスケールしなければならない
7. コールドスタートを処理する場合、システムはLambda関数が使用される場合は適切なウォームアップ戦略を実装しなければならない